#!/usr/bin/env ruby
# frozen_string_literal: true

require 'kubernetes-deploy'

require 'optparse'

skip_wait = false
template_dir = nil
ARGV.options do |opts|
  opts.on("--skip-wait") { skip_wait = true }
  opts.on("--template-dir=DIR") { |v| template_dir = v }
  opts.on("--timeout=TIMEOUT") { |v| KubernetesDeploy::KubernetesResource::timeout_override = v.to_i }
  opts.parse!
end

if !template_dir && ENV.key?("ENVIRONMENT")
  template_dir = "config/deploy/#{ENV['ENVIRONMENT']}"
end

if !template_dir || template_dir.empty?
  puts "Template directory is unknown. " \
    "Either specify --template-dir argument or set $ENVIRONMENT to use config/deploy/$ENVIRONMENT as a default path."
  exit 1
end

revision = ENV.fetch('REVISION') do
  puts "ENV['REVISION'] is missing. Please specify the commit SHA"
  exit 1
end

KubernetesDeploy::Runner.with_friendly_errors do
  runner = KubernetesDeploy::Runner.new(
    namespace: ARGV[0],
    context: ARGV[1],
    current_sha: revision,
    template_dir: template_dir,
    wait_for_completion: !skip_wait,
  )
  runner.run
end
